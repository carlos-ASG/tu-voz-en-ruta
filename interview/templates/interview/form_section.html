{% extends 'organization/base.html' %}
{% load static %}

{% block title %}Encuesta de Satisfacción{% endblock %}

{% block content %}
<form method="post" action="{% url 'interview:submit_survey' %}" class="survey-form" id="surveyForm">
    {% csrf_token %}
    
    <!-- SECCIÓN 0: Selección de Unidad -->
    <section class="form-section unit-info-section">
        <h2 class="section-title">
            <span class="section-number">1</span>
            Selección de Unidad
        </h2>
        
        {% if transit_number %}
        <!-- Si ya hay transit_number, mostrar info de la unidad con campo hidden -->
        <div class="unit-info-box">
            {{ unit_form.unit }}
            
            {% if unit_form.unit.value %}
                <p><strong>Unidad seleccionada:</strong> {{ unit_form.unit.field.queryset.first.transit_number }}</p>
                {% if unit_form.unit.field.queryset.first.route %}
                <p><strong>Ruta:</strong> {{ unit_form.unit.field.queryset.first.route.name }}</p>
                {% endif %}
            {% endif %}
        </div>
        {% else %}
        <!-- Si no hay transit_number, mostrar selector -->
        <div class="form-group">
            {{ unit_form.unit.errors }}
            {{ unit_form.unit.label_tag }}
            {{ unit_form.unit }}
            {% if unit_form.unit.help_text %}
            <small class="help-text">{{ unit_form.unit.help_text }}</small>
            {% endif %}
        </div>
        {% endif %}
    </section>

    <!-- SECCIÓN 1: Preguntas de la Encuesta -->
    <section class="form-section questions-section">
        <h2 class="section-title">
            <span class="section-number">2</span>
            Califica tu Experiencia
        </h2>
        
        {% for question_data in survey_form.get_questions_data %}
            {% with field=question_data.field question_obj=question_data.question_obj question_type=question_data.question_type %}
            <div class="question-block" data-question-id="{{ question_data.question_id }}" data-question-type="{{ question_type }}">
                <div class="question-header">
                    <label class="question-text" for="{{ field.id_for_label }}">
                        {{ forloop.counter }}. {{ field.label }}
                        {% if field.field.required %}
                        <span class="required-indicator">*</span>
                        {% endif %}
                    </label>
                </div>

                <div class="question-input">
                    {% if question_type == 'rating' %}
                    <!-- Tipo: Calificación (estrellas) -->
                    <div class="rating-input">
                        {{ field }}
                        <div class="rating-stars" data-question="{{ question_data.question_id }}">
                            {% for value in "12345" %}
                            <button type="button" class="star" data-value="{{ value }}" aria-label="{{ value }} estrella{{ value|pluralize }}">
                                <svg class="star-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                                    <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"></path>
                                </svg>
                            </button>
                            {% endfor %}
                        </div>
                        <span class="rating-label" id="ratingLabel_{{ question_data.question_id }}">Selecciona tu calificación</span>
                    </div>
                    
                    {% elif question_type == 'text' %}
                    <!-- Tipo: Texto libre -->
                    {{ field.errors }}
                    {{ field }}
                    
                    {% elif question_type == 'choice' %}
                    <!-- Tipo: Opción única (radio) -->
                    {{ field.errors }}
                    <div class="options-list radio-options">
                        {% for radio in field %}
                        <label class="option-item">
                            {{ radio.tag }}
                            <span class="option-label">{{ radio.choice_label }}</span>
                        </label>
                        {% endfor %}
                    </div>
                    
                    {% elif question_type == 'multi_choice' %}
                    <!-- Tipo: Múltiples opciones (checkbox) -->
                    {{ field.errors }}
                    <div class="options-list checkbox-options">
                        {% for checkbox in field %}
                        <label class="option-item">
                            {{ checkbox.tag }}
                            <span class="option-label">{{ checkbox.choice_label }}</span>
                        </label>
                        {% endfor %}
                    </div>
                    {% endif %}
                </div>
            </div>
            {% endwith %}
        {% endfor %}
    </section>

    <!-- SECCIÓN 2: Quejas y Sugerencias -->
    <section class="form-section complaint-section">
        <h2 class="section-title">
            <span class="section-number">3</span>
            ¿Tienes alguna queja o sugerencia?
        </h2>
        <p class="section-description">
            Esta sección es opcional. Si deseas reportar algún problema o hacer una sugerencia, completa la información a continuación.
        </p>

        <div class="form-group">
            {{ complaint_form.complaint_reason.errors }}
            {{ complaint_form.complaint_reason.label_tag }}
            {{ complaint_form.complaint_reason }}
        </div>

        <div class="form-group">
            {{ complaint_form.complaint_text.errors }}
            {{ complaint_form.complaint_text.label_tag }}
            {{ complaint_form.complaint_text }}
            {% if complaint_form.complaint_text.help_text %}
            <small class="help-text">{{ complaint_form.complaint_text.help_text }}</small>
            {% endif %}
        </div>
    </section>

    <!-- SECCIÓN DE EMERGENCIA -->
    <section class="emergency-section">
        <a href="tel:911" class="emergency-link">
            <svg class="emergency-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path>
            </svg>
            <span class="emergency-text">
                <strong>¿Sufres algún tipo de acoso?</strong>
                <span class="emergency-subtext">Llama al 911</span>
            </span>
        </a>
    </section>

    <!-- SECCIÓN 3: Verificación reCAPTCHA -->
    {{ survey_form.captcha.errors }}
    {{ survey_form.captcha }}

    <!-- Botones de acción -->
    <div class="form-actions">
        <button type="reset" class="btn btn-secondary">
            <svg class="btn-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"></path>
                <path d="M3 3v5h5"></path>
            </svg>
            Limpiar formulario
        </button>
        <button type="submit" class="btn btn-primary">
            <svg class="btn-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                <polyline points="22 4 12 14.01 9 11.01"></polyline>
            </svg>
            Enviar encuesta
        </button>
    </div>
</form>

    <p class="admin-link-container">
        <a href="{% url 'admin:index' %}" class="admin-link" title="Panel de Administración">
            <svg class="admin-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.5a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"></path>
                <circle cx="12" cy="12" r="3"></circle>
            </svg>
            Administración
        </a>
    </p>

{% endblock %}

{% block extra_js %}
    <script src="{% static 'interview/js/stars_manager.js' %}"></script>
    <script src="{% static 'interview/js/enable_textarea.js' %}"></script>
{% endblock %}
