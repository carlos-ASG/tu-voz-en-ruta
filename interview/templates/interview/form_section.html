{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Encuesta de Satisfacción - Buzón de Quejas</title>
    <link rel="stylesheet" href="{% static 'interview/css/form_style.css' %}">
</head>
<body>
    <div class="form-container">
        <header class="form-header">
            <h1>Encuesta de Satisfacción del Servicio</h1>
            <p class="subtitle">Tu opinión es importante para mejorar nuestro servicio</p>
        </header>

        <form method="post" action="{% url 'interview:submit_survey' %}" class="survey-form" id="surveyForm">
            {% csrf_token %}
            
            <!-- Sección 1: Selección de unidad -->
            <section class="form-section unit-section">
                <h2 class="section-title">
                    <span class="section-number">1</span>
                    Información del Viaje
                </h2>
                <div class="form-group">
                    <label for="unit_number" class="required">Número de Unidad</label>
                    <select name="unit_number" id="unit_number" required class="form-control">
                        <option value="">-- Selecciona la unidad --</option>
                        {% for unit in units %}
                        <option value="{{ unit.id }}">
                            Unidad {{ unit.unit_number }}
                            {% if unit.route %} - Ruta: {{ unit.route.name }}{% endif %}
                        </option>
                        {% endfor %}
                    </select>
                    <small class="help-text">Selecciona el número de la unidad en la que viajaste</small>
                </div>
            </section>

            <!-- Sección 2: Preguntas de la encuesta -->
            <section class="form-section questions-section">
                <h2 class="section-title">
                    <span class="section-number">2</span>
                    Califica tu Experiencia
                </h2>
                
                {% for question in questions %}
                <div class="question-block" data-question-id="{{ question.id }}" data-question-type="{{ question.type }}">
                    <div class="question-header">
                        <label class="question-text">
                            {{ forloop.counter }}. {{ question.text }}
                            {% if question.type == 'rating' or question.type == 'text' %}
                            <span class="required-indicator">*</span>
                            {% endif %}
                        </label>
                    </div>

                    <div class="question-input">
                        {% if question.type == 'rating' %}
                        <!-- Tipo: Calificación (estrellas/escala) -->
                        <div class="rating-input">
                            <input type="hidden" name="question_{{ question.id }}_rating" id="rating_{{ question.id }}" required>
                            <div class="rating-stars" data-question="{{ question.id }}">
                                <button type="button" class="star" data-value="1" aria-label="1 estrella">
                                    <svg class="star-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                                        <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"></path>
                                    </svg>
                                </button>
                                <button type="button" class="star" data-value="2" aria-label="2 estrellas">
                                    <svg class="star-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                                        <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"></path>
                                    </svg>
                                </button>
                                <button type="button" class="star" data-value="3" aria-label="3 estrellas">
                                    <svg class="star-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                                        <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"></path>
                                    </svg>
                                </button>
                                <button type="button" class="star" data-value="4" aria-label="4 estrellas">
                                    <svg class="star-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                                        <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"></path>
                                    </svg>
                                </button>
                                <button type="button" class="star" data-value="5" aria-label="5 estrellas">
                                    <svg class="star-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                                        <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"></path>
                                    </svg>
                                </button>
                            </div>
                            <span class="rating-label" id="ratingLabel_{{ question.id }}">Selecciona tu calificación</span>
                        </div>

                        {% elif question.type == 'text' %}
                        <!-- Tipo: Texto libre -->
                        <textarea 
                            name="question_{{ question.id }}_text" 
                            id="text_{{ question.id }}" 
                            class="form-control textarea-input" 
                            rows="3" 
                            placeholder="Escribe tu respuesta aquí..."
                            required
                        ></textarea>

                        {% elif question.type == 'choice' %}
                        <!-- Tipo: Opción única (radio) -->
                        <div class="options-list radio-options">
                            {% for option in question.options.all %}
                            <label class="option-item">
                                <input 
                                    type="radio" 
                                    name="question_{{ question.id }}_choice" 
                                    value="{{ option.id }}"
                                    id="option_{{ option.id }}"
                                >
                                <span class="option-label">{{ option.text }}</span>
                            </label>
                            {% endfor %}
                        </div>

                        {% elif question.type == 'multi_choice' %}
                        <!-- Tipo: Múltiples opciones (checkbox) -->
                        <div class="options-list checkbox-options">
                            {% for option in question.options.all %}
                            <label class="option-item">
                                <input 
                                    type="checkbox" 
                                    name="question_{{ question.id }}_multichoice" 
                                    value="{{ option.id }}"
                                    id="option_{{ option.id }}"
                                >
                                <span class="option-label">{{ option.text }}</span>
                            </label>
                            {% endfor %}
                        </div>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </section>

            <!-- Sección 3: Quejas (opcional) -->
            <section class="form-section complaint-section">
                <h2 class="section-title">
                    <span class="section-number">3</span>
                    ¿Tienes alguna queja o sugerencia?
                </h2>
                <p class="section-description">
                    Esta sección es opcional. Si deseas reportar algún problema o hacer una sugerencia, completa la información a continuación.
                </p>

                <div class="form-group">
                    <label for="complaint_reason">Motivo de la queja</label>
                    <select name="complaint_reason" id="complaint_reason" class="form-control">
                        <option value="">-- Selecciona un motivo (opcional) --</option>
                        {% for reason in complaint_reasons %}
                        <option value="{{ reason.id }}">{{ reason.label }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="form-group">
                    <label for="complaint_text">Describe tu queja o sugerencia</label>
                    <textarea 
                        name="complaint_text" 
                        id="complaint_text" 
                        class="form-control textarea-input complaint-textarea" 
                        rows="5" 
                        placeholder="Describe detalladamente tu queja o sugerencia..."
                    ></textarea>
                    <small class="help-text">
                        Tu queja será revisada y procesada para mejorar el servicio. Máximo 1000 caracteres.
                    </small>
                </div>
            </section>

            <!-- Botones de acción -->
            <div class="form-actions">
                <button type="reset" class="btn btn-secondary">
                    <svg class="btn-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"></path>
                        <path d="M3 3v5h5"></path>
                    </svg>
                    Limpiar formulario
                </button>
                <button type="submit" class="btn btn-primary">
                    <svg class="btn-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                        <polyline points="22 4 12 14.01 9 11.01"></polyline>
                    </svg>
                    Enviar encuesta
                </button>
            </div>
        </form>

        <footer class="form-footer">
            <p>Gracias por tu participación. Tu opinión nos ayuda a mejorar.</p>
            <p class="admin-link-container">
                <a href="{% url 'admin:index' %}" class="admin-link" title="Panel de Administración">
                    <svg class="admin-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.5a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"></path>
                        <circle cx="12" cy="12" r="3"></circle>
                    </svg>
                    Administración
                </a>
            </p>
        </footer>
    </div>

    <script>
        // Script para manejar calificación con estrellas
        document.addEventListener('DOMContentLoaded', function() {
            const ratingContainers = document.querySelectorAll('.rating-stars');
            
            ratingContainers.forEach(container => {
                const stars = container.querySelectorAll('.star');
                const questionId = container.dataset.question;
                const hiddenInput = document.getElementById('rating_' + questionId);
                const ratingLabel = document.getElementById('ratingLabel_' + questionId);
                
                stars.forEach((star, index) => {
                    star.addEventListener('click', function(e) {
                        e.preventDefault();
                        const value = parseInt(this.dataset.value);
                        hiddenInput.value = value;
                        
                        // Actualizar visualización de estrellas
                        stars.forEach((s, i) => {
                            if (i < value) {
                                s.classList.add('active');
                            } else {
                                s.classList.remove('active');
                            }
                        });
                        
                        // Actualizar etiqueta
                        const labels = ['', 'Muy malo', 'Malo', 'Regular', 'Bueno', 'Excelente'];
                        ratingLabel.textContent = labels[value];
                    });
                    
                    // Efecto hover
                    star.addEventListener('mouseenter', function() {
                        const value = parseInt(this.dataset.value);
                        stars.forEach((s, i) => {
                            if (i < value) {
                                s.classList.add('hover');
                            } else {
                                s.classList.remove('hover');
                            }
                        });
                    });
                });
                
                container.addEventListener('mouseleave', function() {
                    stars.forEach(s => s.classList.remove('hover'));
                });
            });
            
            // Validación del formulario
            const form = document.getElementById('surveyForm');
            form.addEventListener('submit', function(e) {
                const unitSelect = document.getElementById('unit_number');
                if (!unitSelect.value) {
                    e.preventDefault();
                    alert('Por favor selecciona un número de unidad');
                    unitSelect.focus();
                    return;
                }
                
                // Validar que todas las preguntas requeridas estén respondidas
                const ratingInputs = document.querySelectorAll('input[name^="question_"][name$="_rating"]');
                let allRated = true;
                ratingInputs.forEach(input => {
                    if (!input.value) {
                        allRated = false;
                    }
                });
                
                if (!allRated) {
                    e.preventDefault();
                    alert('Por favor califica todas las preguntas con estrellas');
                    return;
                }
            });
            
            // Contador de caracteres para queja
            const complaintTextarea = document.getElementById('complaint_text');
            if (complaintTextarea) {
                complaintTextarea.setAttribute('maxlength', '1000');
            }
        });
    </script>
</body>
</html>
